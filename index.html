<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‘íƒ€ìœ„í‚¤</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --bg-main: #f5f5f5; --bg-card: #fff; --pink-50: #ebebeb; --pink-100: #e0e0e0; --pink-200: #bdbdbd; --pink-300: #9e9e9e; --pink-400: #757575; --pink-500: #616161; --pink-600: #424242;
    --text-primary: #212121; --text-secondary: #616161; --text-tertiary: #9e9e9e; --border: #e0e0e0;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.08); --shadow-md: 0 4px 12px rgba(0,0,0,0.12); --shadow-lg: 0 12px 24px rgba(0,0,0,0.16);
}
body.dark {
    --bg-main: #1a1a1a; --bg-card: #2d2d2d; --pink-50: #3a3a3a; --pink-100: #404040; --pink-200: #505050; --pink-300: #606060; --pink-400: #888; --pink-500: #aaa; --pink-600: #ccc;
    --text-primary: #e8e8e8; --text-secondary: #b0b0b0; --text-tertiary: #808080; --border: #404040;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3); --shadow-md: 0 4px 12px rgba(0,0,0,0.4); --shadow-lg: 0 12px 24px rgba(0,0,0,0.5);
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', 'Segoe UI', sans-serif; background: var(--bg-main); color: var(--text-primary); line-height: 1.6; padding-bottom: 100px; }
.sticky-top { position: sticky; top: 0; z-index: 100; background: var(--bg-main); }
header { background: var(--bg-card); padding: 40px 24px 32px; text-align: center; border-bottom: 1px solid var(--border); position: relative; }
.title-wrap { margin: 0 auto; max-width: 480px; }
.title-row { display: flex; justify-content: center; align-items: baseline; gap: 10px; flex-wrap: wrap; }
.title-row .app-version { font-size: 0.75rem; color: var(--text-tertiary); font-weight: normal; }
.dark-mode-toggle { position: absolute; top: 16px; right: 24px; width: 40px; height: 40px; border: 1px solid var(--border); border-radius: 50%; background: var(--bg-card); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
.dark-mode-toggle:hover { background: var(--pink-50); }
body.dark .dark-mode-toggle { background: var(--pink-100); }
h1 { font-size: 2.2rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.03em; line-height: 1.2; }
.title-sub { font-size: 0.85rem; color: var(--text-tertiary); margin-top: 8px; }
.empty-hint { margin-top: 14px; font-size: 0.8rem; color: var(--text-secondary); }
.empty-hint strong { color: var(--text-primary); }
.tabs { display: flex; justify-content: center; gap: 8px; padding: 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
.tab-btn { background: transparent; border: 1px solid var(--border); padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; color: var(--text-secondary); }
.tab-btn:hover { background: var(--pink-50); }
.tab-btn.active { background: var(--pink-500); color: white; border-color: var(--pink-500); }
.count { font-size: 12px; opacity: 0.8; margin-left: 6px; }
.controls { max-width: 1200px; margin: 24px auto; padding: 0 24px 8px; }
.filter-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
.search-box { flex: 1; min-width: 160px; }
.search-box input, .filter-row select { height: 40px; padding: 0 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg-card); color: var(--text-primary); width: 100%; }
.filter-row select { width: 130px; }
.action-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
.action-row label { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); cursor: pointer; }
.action-row button { height: 36px; padding: 0 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; cursor: pointer; background: var(--bg-card); color: var(--text-secondary); }
.action-row button:hover { background: var(--pink-50); color: var(--text-primary); }
.action-row button.primary { background: var(--pink-500); color: white; border-color: var(--pink-500); }
.grid { max-width: 1200px; margin: 0 auto; padding: 0 24px; display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; align-content: start; }
.list-item { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; transition: box-shadow 0.2s; }
.list-item:hover { box-shadow: var(--shadow-sm); }
.list-item.collected { opacity: 0.6; }
.list-item.open { grid-column: 1 / -1; z-index: 1; }
.list-item-ghost { opacity: 0.45; cursor: pointer; position: relative; z-index: 15; pointer-events: auto; }
.list-item-ghost .list-item-detail { display: none !important; pointer-events: none; }
.list-item-ghost .ghost-overlay { position: absolute; inset: 0; z-index: 5; cursor: pointer; border: none; background: transparent; width: 100%; height: 100%; padding: 0; font: inherit; color: inherit; }
.list-item-name { display: flex; align-items: center; gap: 12px; padding: 14px 16px; cursor: pointer; user-select: none; }
.list-item-name .icon { font-size: 22px; width: 32px; text-align: center; flex-shrink: 0; }
.list-item-name .name { font-size: 15px; font-weight: 600; color: var(--text-primary); flex: 1; min-width: 0; }
.list-item-name .chevron { font-size: 14px; color: var(--text-tertiary); transition: transform 0.2s; flex-shrink: 0; }
.list-item.open .list-item-name .chevron { transform: rotate(180deg); }
.list-item-detail { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }
.list-item.open .list-item-detail { display: block; padding-top: 12px; }
.detail-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
.detail-label { color: var(--text-tertiary); }
.detail-value { color: var(--text-secondary); text-align: right; max-width: 70%; word-break: break-word; }
.star-rating { display: flex; gap: 2px; font-size: 14px; margin-top: 8px; }
.star { cursor: pointer; color: #e0e0e0; }
.star.filled { color: #FFD700; }
.detail-row-price .star-adj { width: 28px; height: 28px; padding: 0; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); cursor: pointer; font-size: 16px; line-height: 1; color: var(--text-secondary); }
.detail-row-price .star-adj:hover { background: var(--pink-50); color: var(--text-primary); }
.detail-row-price .star-display { font-size: 13px; color: var(--text-secondary); min-width: 1.8em; text-align: center; }
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000; justify-content: center; align-items: center; }
.modal.show { display: flex; }
.modal-content { background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 480px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: var(--shadow-lg); }
.modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; background: var(--pink-50); border: none; border-radius: 50%; font-size: 18px; cursor: pointer; }
.modal-close:hover { background: var(--pink-500); color: white; }
.modal-content h2 { margin-bottom: 20px; font-size: 20px; }
.btn-save { background: var(--pink-500); color: white; height: 42px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
.empty-state { grid-column: 1/-1; text-align: center; padding: 60px 24px; color: var(--text-tertiary); }
.empty-state-icon { font-size: 40px; margin-bottom: 12px; }
.loading { text-align: center; padding: 40px; color: var(--text-tertiary); grid-column: 1/-1; }
    </style>
</head>
<body>
    <div class="sticky-top">
    <header>
        <button type="button" id="darkModeToggle" class="dark-mode-toggle" title="ë‹¤í¬ ëª¨ë“œ">ğŸŒ™</button>
        <div class="title-wrap">
            <div class="title-row">
                <h1>ë‘íƒ€ìœ„í‚¤</h1>
                <span id="versionInfo" class="app-version"></span>
            </div>
            <p class="title-sub">ì–´ë¥˜ Â· ê³¤ì¶© Â· ì¡°ë¥˜ Â· ìš”ë¦¬</p>
            <p id="madeBy" class="title-sub" style="margin-top:2px; font-size:0.7rem; color:var(--text-tertiary);">Made By ì„í˜„</p>
            <p id="emptyDataHint" class="empty-hint" style="display:none;">ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë¬¸ì„œ í´ë”ì˜ <strong>Heartowiki\data\config.json</strong>ì— <strong>data_source</strong>ì™€ <strong>github_repo</strong>(ë˜ëŠ” drive_file_id)ë¥¼ ë„£ì€ ë’¤ <strong>ë°ì´í„° ìƒˆë¡œê³ ì¹¨</strong>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            <p id="dataErrorHint" class="empty-hint" style="display:none; margin-top:8px; color:#c62828; font-size:0.9rem;"></p>
        </div>
    </header>
    <nav class="tabs" id="tabsContainer"></nav>
    <div class="controls">
        <div class="filter-row">
            <div class="search-box"><input type="text" id="searchBox" placeholder="ğŸ” ìƒë¬¼ ì´ë¦„ ê²€ìƒ‰"></div>
            <select id="locationFilter"><option value="">ğŸ“ ì§€ì—­ ì „ì²´</option></select>
            <select id="levelFilter"><option value="">í•„ìš” ì·¨ë¯¸ ë ˆë²¨ ì „ì²´</option></select>
            <select id="weatherFilter"><option value="">ğŸŒ¤ï¸ ë‚ ì”¨ ì „ì²´</option></select>
            <select id="recipeSortBy" style="display:none;"><option value="excel">ê¸°ë³¸ê°’</option><option value="price-asc">ê°€ê²© ë‚®ì€ìˆœ</option><option value="price-desc">ê°€ê²© ë†’ì€ìˆœ</option></select>
        </div>
        <div class="action-row">
            <label><input type="checkbox" id="hideCompleted"> ìˆ˜ì§‘ ì™„ë£Œ ìˆ¨ê¹€</label>
            <button type="button" id="btnRefresh" class="primary">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            <button type="button" id="btnAppUpdate">ğŸ“¦ ì—…ë°ì´íŠ¸ í™•ì¸</button>
        </div>
    </div>
    </div>
    <div id="dataGrid" class="grid">
        <div class="loading" id="loadingState">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeUpdateModal">Ã—</button>
            <h2>ğŸ“¦ ì—…ë°ì´íŠ¸</h2>
            <p id="updateMessage" style="margin-bottom:16px; color:var(--text-secondary);"></p>
            <p id="updateDataHint" style="font-size:13px; color:var(--pink-600); margin-bottom:12px; display:none;"></p>
            <p id="updateHint" style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìƒˆ ë²„ì „ì„ ë°›ì•„ ì•±ì´ ìë™ìœ¼ë¡œ êµì²´Â·ì¬ì‹œì‘ë©ë‹ˆë‹¤.</p>
            <button type="button" id="btnUpdateApply" class="btn-save" style="width:100%; margin-bottom:8px;">ì—…ë°ì´íŠ¸ ì ìš©</button>
            <button type="button" id="btnUpdateDownload" class="btn-save" style="width:100%; background:var(--pink-300);">ë¸Œë¼ìš°ì €ë¡œ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <script>
(function() {
    let CREATURES_DATA = { ì–´ë¥˜: [], ê³¤ì¶©: [], ì¡°ë¥˜: [], ìš”ë¦¬: [] };
    const CATEGORY_CONFIG = { 'ì–´ë¥˜': { icon: 'ğŸŸ', order: 1 }, 'ê³¤ì¶©': { icon: 'ğŸ¦‹', order: 2 }, 'ì¡°ë¥˜': { icon: 'ğŸ¦…', order: 3 }, 'ìš”ë¦¬': { icon: 'ğŸ³', order: 4 } };
    let _userState = { stars: {}, priceStars: {}, userCreatures: { ì–´ë¥˜: [], ê³¤ì¶©: [], ì¡°ë¥˜: [], ìš”ë¦¬: [] }, settings: { currentTab: 'ì–´ë¥˜', sortBy: 'level-asc' } };

    function getApi() {
        if (window.pywebview && window.pywebview.api) return window.pywebview.api;
        return null;
    }

    const Storage = {
        loadStars() { return _userState.stars || {}; },
        saveStars(s) { _userState.stars = s; const api = getApi(); if (api) api.save_user_data(s, null, null); },
        loadUserCreatures() { return _userState.userCreatures || { ì–´ë¥˜: [], ê³¤ì¶©: [], ì¡°ë¥˜: [], ìš”ë¦¬: [] }; },
        saveUserCreatures(c) { _userState.userCreatures = c; const api = getApi(); if (api) api.save_user_data(null, c, null); },
        loadSettings() { return _userState.settings || { currentTab: 'ì–´ë¥˜', sortBy: 'level-asc' }; },
        saveSettings(s) { _userState.settings = s; const api = getApi(); if (api) api.save_user_data(null, null, s); }
    };

    const CardManager = {
        stars: {},
        priceStars: {},
        getStars(cat, name) { return this.stars[cat + '_' + name] || 0; },
        getPriceStars(cat, name) { return this.priceStars[cat + '_' + name] ?? 1; },
        setStars(cat, name, rating) {
            const key = cat + '_' + name;
            const cur = this.stars[key] || 0;
            this.stars[key] = (cur === 1 && rating === 1) ? 0 : rating;
            Storage.saveStars(this.stars);
            App.render();
        },
        setPriceStars(cat, name, rating) {
            const key = cat + '_' + name;
            this.priceStars[key] = Math.max(1, Math.min(5, rating));
            App.render();
        },
        createListItem(item, cat) {
            const isRecipe = cat === 'ìš”ë¦¬';
            const name = item.ëª…ì¹­ || '';
            const stars = this.getStars(cat, name);
            const priceStars = this.getPriceStars(cat, name);
            const wrap = document.createElement('div');
            wrap.className = 'list-item' + (stars === 5 ? ' collected' : '');
            wrap.dataset.category = cat;
            wrap.dataset.name = name;
            const nameRow = document.createElement('div');
            nameRow.className = 'list-item-name';
            nameRow.innerHTML = '<span class="icon">' + (CATEGORY_CONFIG[cat]?.icon || 'ğŸ“¦') + '</span><span class="name">' + escapeHtml(name) + '</span><span class="chevron">â–¼</span>';
            nameRow.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const grid = document.getElementById('dataGrid');
                const wasOpen = wrap.classList.contains('open');
                const previousOpenEl = grid.querySelector('.list-item.open');
                const previousOpenName = previousOpenEl ? previousOpenEl.dataset.name : null;
                if (wasOpen) {
                    App.closeOpenCard();
                    return;
                }
                grid.querySelectorAll('.list-item.open').forEach(el => { el.classList.remove('open'); });
                wrap.classList.add('open');
                App.openCard = { tab: App.currentTab, name: wrap.dataset.name };
                App.ghostCard = (previousOpenEl && previousOpenEl !== wrap && previousOpenName)
                    ? { tab: App.currentTab, name: previousOpenName }
                    : null;
                App.render();
            };
            wrap.appendChild(nameRow);
            const detail = document.createElement('div');
            detail.className = 'list-item-detail';
            function addRow(label, value) { if (value === undefined || value === null) return; if (value === '') return; const r = document.createElement('div'); r.className = 'detail-row'; r.innerHTML = '<span class="detail-label">' + escapeHtml(label) + '</span><span class="detail-value">' + escapeHtml(value) + '</span>'; detail.appendChild(r); }
            function addRowPre(label, value) { if (value === undefined || value === null || value === '') return; const r = document.createElement('div'); r.className = 'detail-row'; const v = document.createElement('span'); v.className = 'detail-value'; v.style.whiteSpace = 'pre-line'; v.textContent = value; r.innerHTML = '<span class="detail-label">' + escapeHtml(label) + '</span>'; r.appendChild(v); detail.appendChild(r); }
            if (isRecipe) {
                if (item.ë ˆë²¨ != null && item.ë ˆë²¨ !== '') addRow('í•„ìš” ì·¨ë¯¸ ë ˆë²¨', 'Lv.' + (formatInteger(item.ë ˆë²¨) || item.ë ˆë²¨));
                addRowPre('ì¬ë£Œ', item.ì¬ë£Œ);
                addRow('ë ˆì‹œí”¼', item.ë ˆì‹œí”¼);
                const basePrice = parseFloat(item.ê°€ê²©) || 0;
                const mult = STAR_MULT[priceStars] || 1;
                const calcPrice = Math.round(basePrice * mult);
                const priceRow = document.createElement('div');
                priceRow.className = 'detail-row detail-row-price';
                const priceVal = document.createElement('span');
                priceVal.className = 'detail-value';
                priceVal.style.display = 'flex';
                priceVal.style.alignItems = 'center';
                priceVal.style.justifyContent = 'flex-end';
                priceVal.style.gap = '8px';
                priceVal.innerHTML = '<span class="price-num">' + calcPrice + '</span> <button type="button" class="star-adj" data-dir="-">âˆ’</button> <span class="star-display">â˜…' + priceStars + '</span> <button type="button" class="star-adj" data-dir="+">+</button>';
                priceRow.innerHTML = '<span class="detail-label">ê°€ê²©</span>';
                priceRow.appendChild(priceVal);
                priceRow.querySelector('.star-adj').onclick = e => { e.stopPropagation(); this.setPriceStars(cat, name, priceStars - 1); };
                priceRow.querySelectorAll('.star-adj')[1].onclick = e => { e.stopPropagation(); this.setPriceStars(cat, name, priceStars + 1); };
                detail.appendChild(priceRow);
                addRow('ë¹„ê³ ', item.ë¹„ê³ );
                const starRow = document.createElement('div');
                starRow.className = 'detail-row';
                starRow.innerHTML = '<span class="detail-label">â­ ìˆ˜ì§‘</span>';
                const starC = document.createElement('div');
                starC.className = 'star-rating';
                for (let i = 1; i <= 5; i++) {
                    const s = document.createElement('span');
                    s.className = 'star ' + (i <= stars ? 'filled' : '');
                    s.textContent = 'â˜…';
                    s.onclick = e => { e.stopPropagation(); this.setStars(cat, name, i); };
                    starC.appendChild(s);
                }
                starRow.appendChild(starC);
                detail.appendChild(starRow);
            } else {
                addRow('ğŸ“ ì§€ì—­', item.ì§€ì—­);
                addRow('ğŸ“Œ ì„¸ë¶€ì§€ì—­', item.ì„¸ë¶€ì§€ì—­);
                addRow('í•„ìš” ì·¨ë¯¸ ë ˆë²¨', item.ë ˆë²¨ != null && item.ë ˆë²¨ !== '' ? 'Lv.' + (formatInteger(item.ë ˆë²¨) || item.ë ˆë²¨) : '');
                addRow('ğŸŒ¤ï¸ ë‚ ì”¨', item.ë‚ ì”¨ì˜í–¥);
                addRow('ğŸ• ì‹œê°„ëŒ€', item.ì‹œê°„ëŒ€);
                addRow('í¬ê¸°', formatInteger(item.í¬ê¸°) || item.í¬ê¸° || '');
                if (cat === 'ì–´ë¥˜') {
                    const basePrice = parseFloat(item.ê°€ê²©) || 0;
                    const mult = STAR_MULT[priceStars] || 1;
                    const calcPrice = Math.round(basePrice * mult);
                    const priceRow = document.createElement('div');
                    priceRow.className = 'detail-row detail-row-price';
                    const priceVal = document.createElement('span');
                    priceVal.className = 'detail-value';
                    priceVal.style.display = 'flex';
                    priceVal.style.alignItems = 'center';
                    priceVal.style.justifyContent = 'flex-end';
                    priceVal.style.gap = '8px';
                    priceVal.innerHTML = '<span class="price-num">' + calcPrice + '</span> <button type="button" class="star-adj" data-dir="-">âˆ’</button> <span class="star-display">â˜…' + priceStars + '</span> <button type="button" class="star-adj" data-dir="+">+</button>';
                    priceRow.innerHTML = '<span class="detail-label">ê°€ê²©</span>';
                    priceRow.appendChild(priceVal);
                    const btnMin = priceRow.querySelector('.star-adj');
                    const btnPlus = priceRow.querySelectorAll('.star-adj')[1];
                    btnMin.onclick = e => { e.stopPropagation(); this.setPriceStars(cat, name, priceStars - 1); };
                    btnPlus.onclick = e => { e.stopPropagation(); this.setPriceStars(cat, name, priceStars + 1); };
                    detail.appendChild(priceRow);
                }
                addRow('ë¹„ê³ ', item.ë¹„ê³ );
                const starRow = document.createElement('div');
                starRow.className = 'detail-row';
                starRow.innerHTML = '<span class="detail-label">â­ ìˆ˜ì§‘</span>';
                const starC = document.createElement('div');
                starC.className = 'star-rating';
                for (let i = 1; i <= 5; i++) {
                    const s = document.createElement('span');
                    s.className = 'star ' + (i <= stars ? 'filled' : '');
                    s.textContent = 'â˜…';
                    s.onclick = e => { e.stopPropagation(); this.setStars(cat, name, i); };
                    starC.appendChild(s);
                }
                starRow.appendChild(starC);
                detail.appendChild(starRow);
            }
            wrap.appendChild(detail);
            return wrap;
        },
        createGhost(item, cat) {
            const name = item.ëª…ì¹­ || '';
            const wrap = document.createElement('div');
            wrap.className = 'list-item list-item-ghost';
            wrap.dataset.category = cat;
            wrap.dataset.name = name;
            const overlay = document.createElement('button');
            overlay.type = 'button';
            overlay.className = 'ghost-overlay';
            overlay.setAttribute('aria-label', 'ë‹«ê¸°: ' + name);
            overlay.textContent = '';
            overlay.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                App.closeOpenCard();
            };
            wrap.appendChild(overlay);
            const nameRow = document.createElement('div');
            nameRow.className = 'list-item-name';
            nameRow.innerHTML = '<span class="icon">' + (CATEGORY_CONFIG[cat]?.icon || 'ğŸ“¦') + '</span><span class="name">' + escapeHtml(name) + '</span><span class="chevron">â–¼</span>';
            nameRow.style.pointerEvents = 'none';
            wrap.appendChild(nameRow);
            const detail = document.createElement('div');
            detail.className = 'list-item-detail';
            detail.style.pointerEvents = 'none';
            wrap.appendChild(detail);
            return wrap;
        }
    };
    function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }
    function formatPrice(p) {
        if (p == null || p === '') return '';
        const n = parseFloat(p);
        return isNaN(n) ? '' : String(Math.round(n));
    }
    function formatInteger(v) {
        if (v == null || v === '') return '';
        const n = parseFloat(v);
        return isNaN(n) ? '' : String(Math.round(n));
    }
    const STAR_MULT = { 1: 1, 2: 1.5, 3: 2, 4: 4, 5: 8 };

    const FilterManager = {
        filter(creatures, opt) {
            return creatures.filter(c => {
                if (opt.search) {
                const searchText = (opt.category === 'ìš”ë¦¬') ? (c.ëª…ì¹­ + (c.ì¬ë£Œ||'') + (c.ë ˆì‹œí”¼||'')) : (c.ëª…ì¹­ + (c.ì§€ì—­||'') + (c.ì„¸ë¶€ì§€ì—­||''));
                if (!searchText.toLowerCase().includes(opt.search.toLowerCase())) return false;
            }
                if (opt.category !== 'ìš”ë¦¬') {
                if (opt.location && c.ì§€ì—­ !== opt.location) return false;
                if (opt.level && c.ë ˆë²¨ !== opt.level) return false;
                if (opt.weather) {
                    const w = c.ë‚ ì”¨ì˜í–¥ || '';
                    if (opt.weather === 'ë¹„' && !w.includes('ë¹„')) return false;
                    if (opt.weather === 'í•´' && !w.includes('í•´')) return false;
                    if (opt.weather === 'ë¬´ì§€ê°œ' && !w.includes('ë¬´ì§€ê°œ')) return false;
                    if (opt.weather === 'ë§‘ì€ ë‚ ' && !w.includes('ë§‘')) return false;
                }
            }
                if (opt.hideCompleted && CardManager.getStars(opt.category, c.ëª…ì¹­) >= 5) return false;
                return true;
            });
        },
        levelNum(item) {
            const v = item.ë ˆë²¨;
            if (v == null || v === '') return 0;
            const n = parseFloat(v);
            if (!isNaN(n)) return n;
            return 20;
        },
        sort(creatures, sortBy, cat) {
            const sorted = [...creatures];
            if (cat === 'ìš”ë¦¬') {
                if (sortBy === 'excel') return sorted;
                sorted.sort((a, b) => {
                    const pA = parseFloat(a.ê°€ê²©) || 0, pB = parseFloat(b.ê°€ê²©) || 0;
                    if (pA !== pB) return sortBy === 'price-desc' ? pB - pA : pA - pB;
                    return (a.ëª…ì¹­ || '').localeCompare(b.ëª…ì¹­ || '');
                });
                return sorted;
            }
            sorted.sort((a, b) => {
                const lA = FilterManager.levelNum(a), lB = FilterManager.levelNum(b);
                if (lA !== lB) return sortBy === 'level-asc' ? lA - lB : lB - lA;
                return (a.ëª…ì¹­ || '').localeCompare(b.ëª…ì¹­ || '');
            });
            return sorted;
        },
        getUnique(creatures, field) {
            const vals = new Set();
            creatures.forEach(c => { if (c[field]) vals.add(c[field]); });
            return Array.from(vals).sort();
        }
    };

    function renderTabs() {
        const container = document.getElementById('tabsContainer');
        container.innerHTML = '';
        const sorted = Object.entries(CATEGORY_CONFIG).sort((a, b) => a[1].order - b[1].order);
        sorted.forEach(([name, config]) => {
            const btn = document.createElement('button');
            btn.className = 'tab-btn' + (name === App.currentTab ? ' active' : '');
            btn.dataset.category = name;
            btn.innerHTML = config.icon + ' ' + name + ' <span class="count" id="count-' + name + '">0</span>';
            btn.addEventListener('click', () => App.switchTab(name));
            container.appendChild(btn);
        });
    }

    const App = {
        currentTab: 'ì–´ë¥˜',
        userCreatures: { ì–´ë¥˜: [], ê³¤ì¶©: [], ì¡°ë¥˜: [] },
        openCard: null,
        ghostCard: null,
        closeOpenCard() {
            if (this.openCard == null && this.ghostCard == null) return;
            this.openCard = null;
            this.ghostCard = null;
            this.render();
        },
        init() {
            CardManager.stars = Storage.loadStars();
            this.userCreatures = Storage.loadUserCreatures();
            const settings = Storage.loadSettings();
            this.currentTab = settings.currentTab || 'ì–´ë¥˜';
            if (settings.darkMode) {
                document.body.classList.add('dark');
                document.getElementById('darkModeToggle').textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('dark');
                document.getElementById('darkModeToggle').textContent = 'ğŸŒ™';
            }
            renderTabs();
            this.setupEvents();
            this.updateFilters();
            this.switchTab(this.currentTab);
        },
        setupEvents() {
            ['searchBox', 'locationFilter', 'levelFilter', 'weatherFilter', 'hideCompleted', 'recipeSortBy'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', () => this.render());
            });
            document.getElementById('btnRefresh').addEventListener('click', () => this.refreshFromDrive());
            document.getElementById('btnAppUpdate').addEventListener('click', checkAppUpdate);
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                const isDark = document.body.classList.toggle('dark');
                const st = Storage.loadSettings();
                Storage.saveSettings({ ...st, darkMode: isDark });
                document.getElementById('darkModeToggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
                document.getElementById('darkModeToggle').title = isDark ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ';
            });
            const grid = document.getElementById('dataGrid');
            grid.addEventListener('mousedown', (e) => {
                if (e.target.closest('.list-item-ghost') || e.target.closest('.list-item.open .list-item-name')) {
                    e.preventDefault();
                    e.stopPropagation();
                    App.closeOpenCard();
                }
            }, true);
            grid.addEventListener('click', (e) => {
                if (e.target.closest('.list-item-ghost') || e.target.closest('.list-item.open .list-item-name')) {
                    e.preventDefault();
                    e.stopPropagation();
                    App.closeOpenCard();
                }
            }, true);
        },
        switchTab(cat) {
            this.currentTab = cat;
            this.openCard = null;
            this.ghostCard = null;
            renderTabs();
            this.updateFilters();
            document.getElementById('searchBox').placeholder = cat === 'ìš”ë¦¬' ? 'ğŸ” ìš”ë¦¬ ì´ë¦„ ê²€ìƒ‰' : 'ğŸ” ìƒë¬¼ ì´ë¦„ ê²€ìƒ‰';
            this.render();
            window.scrollTo(0, 0);
        },
        updateFilters() {
            const cat = this.currentTab;
            const creatures = this.getAll(cat);
            const isRecipe = cat === 'ìš”ë¦¬';
            ['locationFilter', 'levelFilter', 'weatherFilter'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = isRecipe ? 'none' : '';
            });
            const recipeSortEl = document.getElementById('recipeSortBy');
            if (recipeSortEl) recipeSortEl.style.display = isRecipe ? '' : 'none';
            if (isRecipe && recipeSortEl) {
                const st = Storage.loadSettings();
                const v = (st.recipeSortBy || 'excel');
                if (['excel', 'price-asc', 'price-desc'].indexOf(v) >= 0) recipeSortEl.value = v;
            }
            const locs = FilterManager.getUnique(creatures, 'ì§€ì—­');
            const locSel = document.getElementById('locationFilter');
            const cur = locSel.value;
            locSel.innerHTML = '<option value="">ğŸ“ ì§€ì—­ ì „ì²´</option>';
            locs.forEach(l => { const o = document.createElement('option'); o.value = l; o.textContent = l; locSel.appendChild(o); });
            if (locs.includes(cur)) locSel.value = cur;
            const levs = FilterManager.getUnique(creatures, 'ë ˆë²¨').filter(l => l);
            levs.sort((a, b) => {
                const na = parseFloat(a), nb = parseFloat(b);
                if (!isNaN(na) && !isNaN(nb)) return na - nb;
                if (!isNaN(na)) return -1;
                if (!isNaN(nb)) return 1;
                return String(a).localeCompare(b);
            });
            const levSel = document.getElementById('levelFilter');
            const curL = levSel.value;
            levSel.innerHTML = '<option value="">í•„ìš” ì·¨ë¯¸ ë ˆë²¨ ì „ì²´</option>';
            levs.forEach(l => { const o = document.createElement('option'); o.value = l; o.textContent = 'Lv.' + (formatInteger(l) || l); levSel.appendChild(o); });
            if (levs.includes(curL)) levSel.value = curL;
            const weathers = new Set();
            creatures.forEach(c => {
                if (c.ë‚ ì”¨ì˜í–¥) {
                    if (c.ë‚ ì”¨ì˜í–¥.includes('ë¹„')) weathers.add('ë¹„');
                    if (c.ë‚ ì”¨ì˜í–¥.includes('í•´')) weathers.add('í•´');
                    if (c.ë‚ ì”¨ì˜í–¥.includes('ë¬´ì§€ê°œ')) weathers.add('ë¬´ì§€ê°œ');
                    if (c.ë‚ ì”¨ì˜í–¥.includes('ë§‘')) weathers.add('ë§‘ì€ ë‚ ');
                }
            });
            const wSel = document.getElementById('weatherFilter');
            const curW = wSel.value;
            wSel.innerHTML = '<option value="">ğŸŒ¤ï¸ ë‚ ì”¨ ì „ì²´</option>';
            Array.from(weathers).sort().forEach(w => { const o = document.createElement('option'); o.value = w; o.textContent = w; wSel.appendChild(o); });
            if (weathers.has(curW)) wSel.value = curW;
        },
        getAll(cat) {
            return [...(CREATURES_DATA[cat] || []), ...(this.userCreatures[cat] || [])];
        },
        render() {
            const grid = document.getElementById('dataGrid');
            let openCard = (this.openCard && this.openCard.tab === this.currentTab) ? this.openCard : null;
            grid.innerHTML = '';
            grid.classList.remove('loading');
            const opt = {
                category: this.currentTab,
                search: document.getElementById('searchBox').value.trim(),
                location: document.getElementById('locationFilter').value,
                level: document.getElementById('levelFilter').value,
                weather: document.getElementById('weatherFilter').value,
                hideCompleted: document.getElementById('hideCompleted').checked
            };
            let creatures = this.getAll(this.currentTab);
            creatures = FilterManager.filter(creatures, opt);
            if (this.currentTab === 'ìš”ë¦¬') {
                const recipeSortEl = document.getElementById('recipeSortBy');
                const recipeSortBy = (recipeSortEl && recipeSortEl.value) ? recipeSortEl.value : 'excel';
                creatures = FilterManager.sort(creatures, recipeSortBy, 'ìš”ë¦¬');
            }
            if (creatures.length === 0) {
                const e = document.createElement('div');
                e.className = 'empty-state';
                e.innerHTML = '<div class="empty-state-icon">ğŸ”</div><div class="empty-state-text">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                grid.appendChild(e);
            } else {
                const ghostFor = openCard && openCard.tab === this.currentTab ? openCard : null;
                let ghostAdded = false;
                creatures.forEach(c => {
                    if (ghostFor && ghostFor.name === c.ëª…ì¹­) {
                        grid.appendChild(CardManager.createGhost(c, this.currentTab));
                        ghostAdded = true;
                    }
                    const el = CardManager.createListItem(c, this.currentTab);
                    if (openCard && openCard.name === c.ëª…ì¹­) {
                        el.classList.add('open');
                    }
                    grid.appendChild(el);
                });
                if (ghostFor && !ghostAdded) {
                    const ghostCreature = this.getAll(this.currentTab).find(c => c.ëª…ì¹­ === ghostFor.name);
                    if (ghostCreature) {
                        grid.insertBefore(CardManager.createGhost(ghostCreature, this.currentTab), grid.firstChild);
                    }
                }
            }
            this.updateCounts();
            this.saveSettings();
        },
        updateCounts() {
            Object.keys(CATEGORY_CONFIG).forEach(c => {
                const el = document.getElementById('count-' + c);
                if (el) el.textContent = this.getAll(c).length;
            });
        },
        addCreature(c) {
            if (this.userCreatures[this.currentTab].some(x => x.ëª…ì¹­ === c.ëª…ì¹­)) return;
            this.userCreatures[this.currentTab].push(c);
            Storage.saveUserCreatures(this.userCreatures);
            this.updateFilters();
            this.render();
        },
        deleteCreature(cat, name) {
            if (!confirm('"' + name + '"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const idx = this.userCreatures[cat].findIndex(c => c.ëª…ì¹­ === name);
            if (idx === -1) return;
            this.userCreatures[cat].splice(idx, 1);
            Storage.saveUserCreatures(this.userCreatures);
            delete CardManager.stars[cat + '_' + name];
            delete CardManager.priceStars[cat + '_' + name];
            Storage.saveStars(CardManager.stars);
            this.updateFilters();
            this.render();
        },
        saveSettings() {
            const prev = Storage.loadSettings();
            const s = { ...prev, currentTab: this.currentTab };
            const recipeSortEl = document.getElementById('recipeSortBy');
            if (this.currentTab === 'ìš”ë¦¬' && recipeSortEl) s.recipeSortBy = recipeSortEl.value;
            Storage.saveSettings(s);
        },
        async refreshFromDrive() {
            const api = getApi();
            if (!api) return;
            document.getElementById('dataGrid').innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            document.getElementById('dataGrid').classList.add('loading');
            try {
                const data = await api.refresh_data();
                CREATURES_DATA = data.base || CREATURES_DATA;
                _userState = data.user || _userState;
                CardManager.stars = _userState.stars || {};
                App.userCreatures = _userState.userCreatures || { ì–´ë¥˜: [], ê³¤ì¶©: [], ì¡°ë¥˜: [], ìš”ë¦¬: [] };
                var total = (CREATURES_DATA.ì–´ë¥˜||[]).length + (CREATURES_DATA.ê³¤ì¶©||[]).length + (CREATURES_DATA.ì¡°ë¥˜||[]).length + (CREATURES_DATA.ìš”ë¦¬||[]).length;
                var errHint = document.getElementById('dataErrorHint');
                if (errHint) {
                    var msg = data.lastError || '';
                    errHint.textContent = msg;
                    errHint.style.display = (total === 0 && msg) ? 'block' : 'none';
                }
                document.getElementById('emptyDataHint').style.display = total === 0 ? 'block' : 'none';
                setVersionInfo(data.appVersion, data.dataVersion);
                App.updateFilters();
                App.render();
            } catch (e) {
                alert('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ' + (e.message || e));
            }
        }
    };

    function setVersionInfo(appVersion, dataVersion) {
        var el = document.getElementById('versionInfo');
        if (!el) return;
        el.textContent = appVersion ? 'v' + appVersion : '';
    }

    function checkAppUpdate() {
        var api = getApi();
        if (!api) return;
        Promise.all([ api.check_app_update(), api.check_data_update ? api.check_data_update() : Promise.resolve({ hasUpdate: false, latestVersion: '' }) ]).then(function(arr) {
            var appResult = arr[0];
            var dataResult = arr[1] || { hasUpdate: false, currentVersion: '', latestVersion: '' };
            var updateMessage = document.getElementById('updateMessage');
            var updateDataHint = document.getElementById('updateDataHint');
            var updateHint = document.getElementById('updateHint');
            var modal = document.getElementById('updateModal');
            var btnApply = document.getElementById('btnUpdateApply');
            var btnDownload = document.getElementById('btnUpdateDownload');
            updateDataHint.style.display = 'none';
            updateDataHint.textContent = '';

            if (dataResult.hasUpdate && dataResult.latestVersion) {
                updateDataHint.textContent = 'ë„ê° ë°ì´í„° v' + dataResult.latestVersion + ' ì‚¬ìš© ê°€ëŠ¥. ì•„ë˜ "ë°ì´í„° ìƒˆë¡œê³ ì¹¨" ë²„íŠ¼ìœ¼ë¡œ ì ìš©í•˜ì„¸ìš”.';
                updateDataHint.style.display = 'block';
            }

            if (!appResult.hasUpdate) {
                if (dataResult.hasUpdate) {
                    updateMessage.textContent = 'ì•±ì€ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤. ë„ê° ë°ì´í„°ë§Œ ìƒˆë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    updateHint.style.display = 'none';
                    btnApply.style.display = 'none';
                    btnDownload.style.display = 'none';
                } else {
                    updateMessage.textContent = 'ì•±ê³¼ ë„ê° ë°ì´í„° ëª¨ë‘ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤.';
                    updateHint.style.display = 'none';
                    btnApply.style.display = 'none';
                    btnDownload.style.display = 'none';
                }
                document.getElementById('closeUpdateModal').onclick = function() { modal.classList.remove('show'); };
                modal.classList.add('show');
                return;
            }

            updateMessage.textContent = appResult.message + ' (ë²„ì „ ' + appResult.version + ')';
            updateHint.style.display = 'block';
            btnApply.style.display = 'block';
            btnDownload.style.display = 'block';
            var downloadUrl = appResult.download_url || '';
            var driveFileId = appResult.exe_file_id || '';

            btnApply.onclick = function() {
                btnApply.disabled = true;
                btnApply.textContent = 'ë‹¤ìš´ë¡œë“œ ì¤‘...';
                api.apply_update(downloadUrl, driveFileId).then(function(result) {
                    if (result.success) {
                        updateHint.textContent = 'ì—…ë°ì´íŠ¸ ì ìš© ì¤‘ì…ë‹ˆë‹¤. ì•±ì´ ê³§ ì¢…ë£Œëœ ë’¤ ë‹¤ì‹œ ì‹¤í–‰ë©ë‹ˆë‹¤.';
                        btnApply.textContent = 'ì¢…ë£Œ ì¤‘...';
                        setTimeout(function() { api.exit_app(); }, 1500);
                    } else {
                        btnApply.disabled = false;
                        btnApply.textContent = 'ì—…ë°ì´íŠ¸ ì ìš©';
                        alert(result.error || 'ì—…ë°ì´íŠ¸ ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }).catch(function() {
                    btnApply.disabled = false;
                    btnApply.textContent = 'ì—…ë°ì´íŠ¸ ì ìš©';
                    alert('ì—…ë°ì´íŠ¸ ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            };
            btnDownload.onclick = function() {
                if (downloadUrl) api.open_download_url(downloadUrl);
                else if (driveFileId) api.open_download_url('https://drive.google.com/uc?export=download&id=' + driveFileId);
                modal.classList.remove('show');
            };
            document.getElementById('closeUpdateModal').onclick = function() { modal.classList.remove('show'); };
            modal.classList.add('show');
        }).catch(function() { alert('ì—…ë°ì´íŠ¸ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
    }
    function bootstrap(data) {
        CREATURES_DATA = data.base || CREATURES_DATA;
        _userState = data.user || _userState;
        document.getElementById('loadingState').remove();
        var total = (CREATURES_DATA.ì–´ë¥˜||[]).length + (CREATURES_DATA.ê³¤ì¶©||[]).length + (CREATURES_DATA.ì¡°ë¥˜||[]).length + (CREATURES_DATA.ìš”ë¦¬||[]).length;
        var hint = document.getElementById('emptyDataHint');
        var errHint = document.getElementById('dataErrorHint');
        if (hint) hint.style.display = total === 0 ? 'block' : 'none';
        if (errHint) {
            var msg = data.lastError || '';
            errHint.textContent = msg;
            errHint.style.display = (total === 0 && msg) ? 'block' : 'none';
        }
        setVersionInfo(data.appVersion, data.dataVersion);
        App.init();
    }

    window.addEventListener('pywebviewready', function() {
        const api = getApi();
        if (!api) {
            document.getElementById('loadingState').textContent = 'APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }
        api.get_app_data().then(bootstrap).catch(function(err) {
            document.getElementById('loadingState').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || err);
        });
    });
})();
    </script>
</body>
</html>
